
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../ros2control/">
      
      
        <link rel="next" href="../hardware/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.20">
    
    
      
        <title>Conceptos básicos de ros2_control - Ros2_control</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e53b48f4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#conceptos-basicos-de-ros2_control" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Ros2_control" class="md-header__button md-logo" aria-label="Ros2_control" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Ros2_control
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Conceptos básicos de ros2_control
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Ros2_control" class="md-nav__button md-logo" aria-label="Ros2_control" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Ros2_control
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introducción e instalación
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ros2control/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Los paquetes de ros2_control
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Conceptos básicos de ros2_control
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Conceptos básicos de ros2_control
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#crear-un-nuevo-paquete" class="md-nav__link">
    <span class="md-ellipsis">
      Crear un nuevo paquete
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#crear-un-archivo-de-configuracion-para-el-controller-manager-y-los-algoritmos-de-control" class="md-nav__link">
    <span class="md-ellipsis">
      Crear un archivo de configuración para el controller manager y los algoritmos de control
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actualizar-el-archivo-xacro-de-la-descripcion-del-robot" class="md-nav__link">
    <span class="md-ellipsis">
      Actualizar el archivo Xacro de la descripción del robot
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#crear-un-archivo-de-lanzamiento-launch-que-inicie-los-controladores" class="md-nav__link">
    <span class="md-ellipsis">
      Crear un archivo de lanzamiento (launch) que inicie los controladores
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#probar-el-robot-controlado-por-ros2_control" class="md-nav__link">
    <span class="md-ellipsis">
      Probar el robot controlado por ros2_control
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ejercicio" class="md-nav__link">
    <span class="md-ellipsis">
      Ejercicio
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Interfaz hardware
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../controlador_propio/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Creación de un controlador propio
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#crear-un-nuevo-paquete" class="md-nav__link">
    <span class="md-ellipsis">
      Crear un nuevo paquete
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#crear-un-archivo-de-configuracion-para-el-controller-manager-y-los-algoritmos-de-control" class="md-nav__link">
    <span class="md-ellipsis">
      Crear un archivo de configuración para el controller manager y los algoritmos de control
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actualizar-el-archivo-xacro-de-la-descripcion-del-robot" class="md-nav__link">
    <span class="md-ellipsis">
      Actualizar el archivo Xacro de la descripción del robot
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#crear-un-archivo-de-lanzamiento-launch-que-inicie-los-controladores" class="md-nav__link">
    <span class="md-ellipsis">
      Crear un archivo de lanzamiento (launch) que inicie los controladores
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#probar-el-robot-controlado-por-ros2_control" class="md-nav__link">
    <span class="md-ellipsis">
      Probar el robot controlado por ros2_control
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ejercicio" class="md-nav__link">
    <span class="md-ellipsis">
      Ejercicio
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="conceptos-basicos-de-ros2_control">Conceptos básicos de ros2_control</h1>
<p>En este apartado se va aplicar ros2_control para mover las articulaciones de un robot de 2 grados de libertad. El paquete ros2_control_sca contiene la descripción del robot utilizando <a href="http://wiki.ros.org/xacro">Xacro</a>. En este apartado se incorporará la información necesaria a la descripción para que pueda ser controlador mediante ros2_control.</p>
<p>En primer lugar se compilarán los paquetes descargados en  ros2_ws, para ello se utilizará el comando colcon (si no se ha hecho ya anteriormente):
<div class="highlight"><pre><span></span><code>cd ~/ros2_ws/ &amp;&amp; colcon build
</code></pre></div>
Además, después de compilar, se debe utilizar el comando source sobre el espacio de trabajo para asegurarse de que los paquetes recién añadidos sean detectados por ROS2:
<div class="highlight"><pre><span></span><code>source install/setup.bash
</code></pre></div>
Ejecuta el siguiente comando para ver en rviz el modelo simulado del robot que se va a controlar:</p>
<p><div class="highlight"><pre><span></span><code>ros2 launch ros2_robot_sca view_robot.launch.py
</code></pre></div>
<img alt="robot simulado con rviz" src="../images/robotrviz.png" /></p>
<p>El modelo de robot que se ha incorporado al mundo simulado no implementa nada de ros2_control. A continuación, se describirán los pasos a seguir para implementar ros2_control desde cero. Para ello se partirá de la descripción del robot en un archivo Xacro. Para agregar ros2_control a nuestro robot, se seguirán los siguientes pasos:</p>
<ul>
<li>Crear un nuevo paquete.</li>
<li>Crear un archivo de configuración para el controller manager y los algoritmos de control.</li>
<li>Actualizar el archivo Xacro de la descripción del robot.</li>
<li>Crear un archivo de lanzamiento (launch) que inicie los controladores.</li>
<li>Probar el robot controlado por ros2_control.</li>
</ul>
<h2 id="crear-un-nuevo-paquete">Crear un nuevo paquete</h2>
<p>Cuando se trabaja con ROS, generalmente se recomienda dividir un proyecto robótico en paquetes separados, ya que esto permite un diseño modular y minimiza las dependencias entre paquetes. Por lo tanto, comencemos creando un nuevo paquete dedicado exclusivamente a almacenar la configuración y los archivos de lanzamiento de ros2_control. Para ello, seguir los pasos que se indican a continuación.</p>
<p>Ir al directorio src dentro de ros2_ws:
<div class="highlight"><pre><span></span><code>cd ~/ros2_ws/src
</code></pre></div>
Crear un nuevo paquete llamado my_robot_bringup ejecutando lo siguiente:
<div class="highlight"><pre><span></span><code>ros2 pkg create --build-type=ament_cmake my_robot_bringup --dependencies urdf xacro robot_state_publisher
</code></pre></div>
Esto producirá la siguiente salida:</p>
<p><img alt="Resultado de crear el paquete my_robot_bringup" src="../images/my_bringup.png" /></p>
<h2 id="crear-un-archivo-de-configuracion-para-el-controller-manager-y-los-algoritmos-de-control">Crear un archivo de configuración para el controller manager y los algoritmos de control</h2>
<p>Dentro del paquete recién creado, se van a agregar los archivos de configuración para ros2_control y los controladores que se utilizarán. El archivo de configuración estará dentro de la carpeta config, así que se agregará esa carpeta a nuestro paquete:
<div class="highlight"><pre><span></span><code>cd ~/ros2_ws/src/my_robot_bringup
</code></pre></div></p>
<div class="highlight"><pre><span></span><code>mkdir config
</code></pre></div>
<p>En la carpeta config crear un archivo llamado controller_configuration.yaml:
<div class="highlight"><pre><span></span><code>touch ~/ros2_ws/src/my_robot_bringup/config/controller_configuration.yaml
</code></pre></div>
Añadirle el siguiente contenido:
<div class="highlight"><pre><span></span><code># Controller manager configuration
controller_manager:
  ros__parameters:
    update_rate: 10  # Hz

    ### Controllers available
    joint_state_broadcaster:
      type: joint_state_broadcaster/JointStateBroadcaster

    forward_position_controller:
      type: forward_command_controller/ForwardCommandController

    joint_trajectory_controller:
      type: joint_trajectory_controller/JointTrajectoryController


### Properties of the controllers that we will use and definition of joints to use ###
forward_position_controller:
  ros__parameters:
    joints:
      - joint1
    interface_name: position


joint_trajectory_controller:
  ros__parameters:
    joints:
      - joint1

    command_interfaces:
      - position

    state_interfaces:
      - position

    state_publish_rate: 200.0 # Hz, Defaults to 50
    action_monitor_rate: 20.0 # Hz, Defaults to 20

    allow_partial_joints_goal: false # Defaults to false
    open_loop_control: true
    allow_integration_in_goal_trajectories: true
    constraints:
      stopped_velocity_tolerance: 0.01 # Defaults to 0.01
      goal_time: 0.0 # Defaults to 0.0 (start immediately)
</code></pre></div></p>
<p>A continuación, se describirá este código por partes:</p>
<div class="highlight"><pre><span></span><code># Controller manager configuration
controller_manager:
  ros__parameters:
    update_rate: 10  # Hz
</code></pre></div>
<p>Los archivos de configuración de ros2_control son simplemente archivos de parámetros típicos para ROS2. Como tal, la primera línea debe especificar el nombre del nodo de ROS2 (controller_manager) y la segunda línea debe ser ros__parameters: con una indentación. Luego, en otro nivel de indentación, configuramos el controller manager estableciendo la frecuencia del bucle de control a 10 Hz. La frecuencia del bucle  de control es uno de los parámetros que se puede ajustar para obtener el comportamiento esperado en nuestros actuadores.</p>
<div class="highlight"><pre><span></span><code>    ### Controllers available
    joint_state_broadcaster:
      type: joint_state_broadcaster/JointStateBroadcaster

    forward_position_controller:
      type: forward_command_controller/ForwardCommandController

    joint_trajectory_controller:
      type: joint_trajectory_controller/JointTrajectoryController
</code></pre></div>
<p>Después, al mismo nivel de indentación, definimos los controladores que queremos tener disponibles. Para definir un controlador, debemos proporcionar un nombre único (que podemos elegir libremente) seguido de dos puntos, y en la siguiente línea ingresamos un tipo de controlador, de la misma manera que en este nuevo ejemplo mostrado aquí:</p>
<div class="highlight"><pre><span></span><code>    joint1_position_controller:
      type: effort_controllers/JointGroupEffortController
</code></pre></div>
<p>El tipo de controlador, se refiere al nombre del plugin ros2_control que se utilizará. Se puede hacer referencia al nombre de los plugins de controladores comunes proporcionados por el paquete ros2_controllers, los cuales se han descrito anteriormente. También es posible crear un plugin de controlador personalizado y asignarle un nombre a tu elección como se describirá más adelante. El resto del archivo de configuración es el siguiente:</p>
<div class="highlight"><pre><span></span><code>### Properties of the controllers that we will use and definition of joints to use ###
forward_position_controller:
  ros__parameters:
    joints:
      - joint1
    interface_name: position


joint_trajectory_controller:
  ros__parameters:
    joints:
      - joint1

    command_interfaces:
      - position

    state_interfaces:
      - position

    state_publish_rate: 200.0 # Hz, Defaults to 50
    action_monitor_rate: 20.0 # Hz, Defaults to 20

    allow_partial_joints_goal: false # Defaults to false
    open_loop_control: true
    allow_integration_in_goal_trajectories: true
    constraints:
      stopped_velocity_tolerance: 0.01 # Defaults to 0.01
      goal_time: 0.0 # Defaults to 0.0 (start immediately)
</code></pre></div>
<p>Finalmente, al nivel de indentación raíz, debemos incluir los parámetros requeridos por los controladores que queremos tener disponibles. En el código de arriba, hay dos controladores cuyas propiedades están siendo definidas. Recuerda que nombramos esos controladores: forward_position_controller y joint_trajectory_controller.</p>
<p>Las propiedades específicas y valores de parámetros que se definen para cada controlador se explicaron anteriormente. Uno de los parámetros de configuración más importantes que se debe definir es el nombre de las articulaciones que serán controladas por cada controlador, que son estas dos líneas aquí:</p>
<div class="highlight"><pre><span></span><code>    joints:
      - joint1
</code></pre></div>
<p>Importante: los nombres de las articulaciones que se definen en este archivo de configuración deben coincidir con los nombres de las articulaciones en el archivo URDF/Xacro. El archivo yaml de arriba, por ejemplo, asigna una articulación con el nombre "joint1" a ambos controladores. "joint1" corresponde al nombre de la articulación definido por la etiqueta XML <joint name="joint1" type="revolute"> dentro del archivo .xacro (rrbot_description.urdf.xacro en la carpeta ros2_ws/src/ros2_robot_sca/description/rrbot/urdf).</p>
<h2 id="actualizar-el-archivo-xacro-de-la-descripcion-del-robot">Actualizar el archivo Xacro de la descripción del robot</h2>
<p>Para habilitar ros2_control, también debemos agregar algunos nuevos elementos XML al archivo URDF o Xacro que describa el robot. En esta sección, se describe cómo modificar un archivo de descripción de robot existente.</p>
<p>Para ello, en primer lugar se describirá la estructura de los ficheros xacro que definen el robot. El fichero xacro principal es rrbot.urdf.xacro que se encuentra en ros2_robot_sca/description/urdf. El contenido de este fichero es:
<div class="highlight"><pre><span></span><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;!-- Revolute-Revolute Manipulator --&gt;
&lt;!--
Copied and modified from ROS1 example -
https://github.com/ros-simulation/gazebo_ros_demos/blob/kinetic-devel/rrbot_description/urdf/rrbot.xacro
--&gt;
&lt;robot xmlns:xacro=&quot;http://www.ros.org/wiki/xacro&quot; name=&quot;2dof_robot&quot;&gt;
  &lt;xacro:arg name=&quot;prefix&quot; default=&quot;&quot; /&gt;
  &lt;xacro:arg name=&quot;use_gazebo&quot; default=&quot;false&quot; /&gt;

  &lt;!-- Import RRBot macro --&gt;
  &lt;xacro:include filename=&quot;$(find ros2_robot_sca)/rrbot/urdf/rrbot_description.urdf.xacro&quot; /&gt;

  &lt;!-- Import Rviz colors --&gt;
  &lt;xacro:include filename=&quot;$(find ros2_robot_sca)/rrbot/urdf/rrbot.materials.xacro&quot; /&gt;

  &lt;!-- Used for fixing robot --&gt;
  &lt;link name=&quot;world&quot;/&gt;

  &lt;xacro:rrbot parent=&quot;world&quot; prefix=&quot;$(arg prefix)&quot;&gt;
    &lt;origin xyz=&quot;0 0 0&quot; rpy=&quot;0 0 0&quot; /&gt;
  &lt;/xacro:rrbot&gt;

&lt;/robot&gt;
</code></pre></div></p>
<p>Se observa que se importan una serie de macros que definirán las características del robot:</p>
<ul>
<li><code>&lt;xacro:include filename="$(find ros2_robot_sca)/rrbot/urdf/rrbot_description.urdf.xacro" /&gt;</code>. Aquí se definen las articulaciones y dimensiones del robot (inercia, características geométricas, etc).</li>
<li><code>&lt;xacro:include filename="$(find ros2_robot_sca)/rrbot/urdf/rrbot.materials.xacro" /&gt;</code>. Aquí se definen los materiales y colores de los eslabones.</li>
</ul>
<p>A continuación definir una nueva macro que incluirá los tags de ros2_control necesarios para controlar las articulaciones. Para ello, añadir el siguiente código justo debajo de las 2 líneas anteriores:
<div class="highlight"><pre><span></span><code>&lt;!-- Import RRBot ros2_control description --&gt;
  &lt;xacro:include filename=&quot;$(find ros2_robot_sca)/ros2_control/rrbot.ros2_control.xacro&quot; /&gt;
</code></pre></div>
Además, en la carpeta ros2_control del paquete ros2_robot_sca/description/ros2_control/ se deberá crear el fichero rrbot.ros2_control.xacro:
<div class="highlight"><pre><span></span><code>touch ~/ros2_ws/src/ros2_robot_sca/description/ros2_control/rrbot.ros2_control.xacro
</code></pre></div>
Incluir el siguiente código en el archivo anterior:
<div class="highlight"><pre><span></span><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;robot xmlns:xacro=&quot;http://www.ros.org/wiki/xacro&quot;&gt;

  &lt;xacro:macro name=&quot;rrbot_ros2_control&quot; params=&quot;name prefix use_gazebo:=^|false&quot;&gt;

    &lt;ros2_control name=&quot;${name}&quot; type=&quot;system&quot;&gt;
      &lt;hardware&gt;
        &lt;xacro:if value=&quot;${use_gazebo}&quot;&gt;
          &lt;plugin&gt;gz_ros2_control/GazeboSimSystem&lt;/plugin&gt;
        &lt;/xacro:if&gt;
        &lt;xacro:unless value=&quot;${use_gazebo}&quot;&gt;
          &lt;plugin&gt;ros2_robot_sca/RRBotSystemPositionOnlyHardware&lt;/plugin&gt;
          &lt;param name=&quot;example_param_hw_start_duration_sec&quot;&gt;0&lt;/param&gt;
          &lt;param name=&quot;example_param_hw_stop_duration_sec&quot;&gt;3.0&lt;/param&gt;
          &lt;param name=&quot;example_param_hw_slowdown&quot;&gt;100&lt;/param&gt;
        &lt;/xacro:unless&gt;
      &lt;/hardware&gt;

      &lt;joint name=&quot;${prefix}joint1&quot;&gt;
        &lt;command_interface name=&quot;position&quot;&gt;
          &lt;param name=&quot;min&quot;&gt;-1&lt;/param&gt;
          &lt;param name=&quot;max&quot;&gt;1&lt;/param&gt;
        &lt;/command_interface&gt;
        &lt;state_interface name=&quot;position&quot;/&gt;
      &lt;/joint&gt;
      &lt;joint name=&quot;${prefix}joint2&quot;&gt;
        &lt;command_interface name=&quot;position&quot;&gt;
          &lt;param name=&quot;min&quot;&gt;-1&lt;/param&gt;
          &lt;param name=&quot;max&quot;&gt;1&lt;/param&gt;
        &lt;/command_interface&gt;
        &lt;state_interface name=&quot;position&quot;/&gt;
      &lt;/joint&gt;
    &lt;/ros2_control&gt;

  &lt;/xacro:macro&gt;

&lt;/robot&gt;
</code></pre></div></p>
<p>Este fichero incorpora los siguientes tags:
<div class="highlight"><pre><span></span><code>&lt;ros2_control name=&quot;${name}&quot; type=&quot;system&quot;&gt;
</code></pre></div>
El framework ros2_control utiliza la etiqueta <code>&lt;ros2_control&gt;</code> en el archivo URDF del robot para describir sus componentes y sus funciones.
<div class="highlight"><pre><span></span><code>&lt;xacro:if value=&quot;${use_gazebo}&quot;&gt;
    &lt;plugin&gt;gz_ros2_control/GazeboSimSystem&lt;/plugin&gt;
&lt;/xacro:if&gt;           
</code></pre></div>
El elemento <hardware> es necesario para definir la interfaz de hardware de ros2_control, que conectará los controladores con los actuadores. En este ejemplo, se utiliza gz_ros2_control/GazeboSimSystem como interfaz de hardware porque se quiere utilizar ros2_control para nuestro robot simulado en Gazebo. En los siguientes apartados, se describirá más detalles de las interfaces hardware. </p>
<p><div class="highlight"><pre><span></span><code>&lt;joint name=&quot;${prefix}joint1&quot;&gt;
    &lt;command_interface name=&quot;position&quot;&gt;
        &lt;param name=&quot;min&quot;&gt;-1&lt;/param&gt;
        &lt;param name=&quot;max&quot;&gt;1&lt;/param&gt;
    &lt;/command_interface&gt;
    &lt;state_interface name=&quot;position&quot;/&gt;
&lt;/joint&gt;
</code></pre></div>
Este bloque de etiquetas XML agrega un elemento <code>&lt;joint name=" "&gt;</code> como un elemento hijo de la etiqueta <code>&lt;ros2_control&gt;</code>. El elemento <code>&lt;joint name=" "&gt;</code> se usa para definir qué interfaces de comando e interfaces de estado están habilitadas para cada articulación. Por ejemplo, aquí se define una única interfaz de comando que solo permite enviar órdenes de posición a las articulaciones. Pero también se podría optar por agregar una segunda interfaz de comando que permita controlar velocidades. Lo mismo aplica a las interfaces de estado. Usando la etiqueta <code>&lt;state_interface name="..."/&gt;</code>, se define qué magnitudes del estado de la articulación (por ejemplo, posición, velocidad, esfuerzo, aceleración, etc.) estarán disponibles (transmitidas) por ros2_control para cada articulación.</p>
<p>Repitiendo la estructura mostrada anteriormente, se agrega tantos elementos <code>&lt;joint name=" "&gt;</code> como articulaciones reales tenga el robot. Luego, dentro de cada uno, se define tantas interfaces de comando e interfaces de estado como necesite nuestro controlador y como soporte el hardware del robot.</p>
<p>Por último, como queremos ejecutar una simulación en Gazebo, también se necesita iniciar un plugin para Gazebo. Añadir este código al final de rrbot.urdf.xacro pero antes de cerrar /robot&gt;:
<div class="highlight"><pre><span></span><code>  &lt;xacro:rrbot_ros2_control
    name=&quot;RRBot&quot; prefix=&quot;$(arg prefix)&quot; use_gazebo=&quot;$(arg use_gazebo)&quot;/&gt;

  &lt;xacro:if value=&quot;$(arg use_gazebo)&quot;&gt;
    &lt;!-- Import Gazebo Classic definitions + plugin --&gt;
    &lt;xacro:include filename=&quot;$(find ros2_robot_sca)/gazebo/rrbot.gazebo.xacro&quot; /&gt;
    &lt;xacro:rrbot_gazebo prefix=&quot;$(arg prefix)&quot;/&gt;
  &lt;/xacro:if&gt;
</code></pre></div></p>
<p>Ten en cuenta que estas etiquetas XML no son necesarias para ros2_control, sino para Gazebo. Este código carga el fichero rrbot.gazebo.xacro que se encuentra en ros2_ws/src/ros2_robot_sca/description/gazebo. Crear ese fichero mediante el comando:</p>
<p><div class="highlight"><pre><span></span><code>touch ~/ros2_ws/src/ros2_robot_sca/description/gazebo/rrbot.gazebo.xacro
</code></pre></div>
Incluir el siguiente código en el archivo anterior:</p>
<p><div class="highlight"><pre><span></span><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;!--
Copied and modified from ROS1 example -
https://github.com/ros-simulation/gazebo_ros_demos/blob/kinetic-devel/rrbot_description/urdf/rrbot.gazebo
--&gt;
&lt;robot xmlns:xacro=&quot;http://ros.org/wiki/xacro&quot;&gt;

  &lt;xacro:macro name=&quot;rrbot_gazebo&quot; params=&quot;prefix&quot;&gt;

    &lt;!-- ros_control plugin --&gt;
    &lt;gazebo&gt;
      &lt;plugin filename=&quot;gz_ros2_control-system&quot; name=&quot;gz_ros2_control::GazeboSimROS2ControlPlugin&quot;&gt;
        &lt;parameters&gt;$(find my_robot_bringup)/config/controller_configuration.yaml&lt;/parameters&gt;
      &lt;/plugin&gt;
    &lt;/gazebo&gt;

    &lt;!-- Link1 --&gt;
    &lt;gazebo reference=&quot;${prefix}base_link&quot;&gt;
      &lt;material&gt;Gazebo/Orange&lt;/material&gt;
    &lt;/gazebo&gt;

    &lt;!-- Link2 --&gt;
    &lt;gazebo reference=&quot;${prefix}link1&quot;&gt;
      &lt;mu1&gt;0.2&lt;/mu1&gt;
      &lt;mu2&gt;0.2&lt;/mu2&gt;
      &lt;material&gt;Gazebo/Yellow&lt;/material&gt;
    &lt;/gazebo&gt;

    &lt;!-- Link3 --&gt;
    &lt;gazebo reference=&quot;${prefix}link2&quot;&gt;
      &lt;mu1&gt;0.2&lt;/mu1&gt;
      &lt;mu2&gt;0.2&lt;/mu2&gt;
      &lt;material&gt;Gazebo/Orange&lt;/material&gt;
    &lt;/gazebo&gt;

  &lt;/xacro:macro&gt;

&lt;/robot&gt;
</code></pre></div>
Observa que dentro de la etiqueta <code>&lt;gazebo&gt;&lt;plugin&gt;</code>, tenemos un elemento <code>&lt;parameter&gt;</code>, que se utiliza para cargar el archivo de configuración .yaml creado en la sección anterior. Por lo tanto, recuerda: cuando se ejecuta ros2_control con un robot simulado en Gazebo, se pasa el archivo de configuración .yaml del controlador aquí, dentro de las etiquetas del plugin de Gazebo.</p>
<h2 id="crear-un-archivo-de-lanzamiento-launch-que-inicie-los-controladores">Crear un archivo de lanzamiento (launch) que inicie los controladores</h2>
<p>Con el archivo de configuración listo y el archivo URDF actualizado, es momento de crear un archivo de lanzamiento para generar el nuevo robot y los controladores. Para ello, ejecutar los siguientes comandos:
<div class="highlight"><pre><span></span><code>cd ~/ros2_ws/src/my_robot_bringup
</code></pre></div></p>
<div class="highlight"><pre><span></span><code>mkdir launch
</code></pre></div>
<p>Crea un nuevo archivo my_robot.launch.py dentro del directorio launch, siguiendo las instrucciones:
<div class="highlight"><pre><span></span><code>cd launch
</code></pre></div></p>
<div class="highlight"><pre><span></span><code>touch my_robot.launch.py
</code></pre></div>
<div class="highlight"><pre><span></span><code>chmod +x my_robot.launch.py
</code></pre></div>
<p>Introducir el siguiente Código en el fichero recién creado:
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">launch</span><span class="w"> </span><span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch.actions</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclareLaunchArgument</span><span class="p">,</span> <span class="n">IncludeLaunchDescription</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch.conditions</span><span class="w"> </span><span class="kn">import</span> <span class="n">IfCondition</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch.launch_description_sources</span><span class="w"> </span><span class="kn">import</span> <span class="n">PythonLaunchDescriptionSource</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch.substitutions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Command</span><span class="p">,</span> <span class="n">FindExecutable</span><span class="p">,</span> <span class="n">PathJoinSubstitution</span><span class="p">,</span> <span class="n">LaunchConfiguration</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch_ros.actions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch_ros.substitutions</span><span class="w"> </span><span class="kn">import</span> <span class="n">FindPackageShare</span>


<span class="k">def</span><span class="w"> </span><span class="nf">generate_launch_description</span><span class="p">():</span>

    <span class="c1"># Declare arguments</span>
    <span class="n">declared_arguments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">declared_arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">DeclareLaunchArgument</span><span class="p">(</span>
            <span class="s2">&quot;gui&quot;</span><span class="p">,</span>
            <span class="n">default_value</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Start Gazebo automatically with this launch file.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Initialize Arguments</span>
    <span class="n">gui</span> <span class="o">=</span> <span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s2">&quot;gui&quot;</span><span class="p">)</span>

    <span class="c1"># gazebo</span>
    <span class="n">gazebo</span> <span class="o">=</span> <span class="n">IncludeLaunchDescription</span><span class="p">(</span>
        <span class="n">PythonLaunchDescriptionSource</span><span class="p">(</span>
            <span class="p">[</span><span class="n">FindPackageShare</span><span class="p">(</span><span class="s2">&quot;ros_gz_sim&quot;</span><span class="p">),</span> <span class="s2">&quot;/launch/gz_sim.launch.py&quot;</span><span class="p">]</span>
        <span class="p">),</span>
        <span class="n">launch_arguments</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;gz_args&quot;</span><span class="p">:</span> <span class="s2">&quot; -r -v 3 empty.sdf&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
    <span class="p">)</span>

    <span class="n">gz_spawn_entity</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="s2">&quot;ros_gz_sim&quot;</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="s2">&quot;create&quot;</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="s2">&quot;screen&quot;</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;-topic&quot;</span><span class="p">,</span>
            <span class="s2">&quot;/robot_description&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rrbot_system_position&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-allow_renaming&quot;</span><span class="p">,</span>
            <span class="s2">&quot;true&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># Get URDF via xacro</span>
    <span class="n">robot_description_content</span> <span class="o">=</span> <span class="n">Command</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">PathJoinSubstitution</span><span class="p">([</span><span class="n">FindExecutable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;xacro&quot;</span><span class="p">)]),</span>
            <span class="s2">&quot; &quot;</span><span class="p">,</span>
            <span class="n">PathJoinSubstitution</span><span class="p">(</span>
                <span class="p">[</span><span class="n">FindPackageShare</span><span class="p">(</span><span class="s2">&quot;ros2_robot_sca&quot;</span><span class="p">),</span> <span class="s2">&quot;urdf&quot;</span><span class="p">,</span> <span class="s2">&quot;rrbot.urdf.xacro&quot;</span><span class="p">]</span>
            <span class="p">),</span>
            <span class="s2">&quot; &quot;</span><span class="p">,</span>
            <span class="s2">&quot;use_gazebo:=true&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">robot_description</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;robot_description&quot;</span><span class="p">:</span> <span class="n">robot_description_content</span><span class="p">}</span>

    <span class="n">robot_controllers</span> <span class="o">=</span> <span class="n">PathJoinSubstitution</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">FindPackageShare</span><span class="p">(</span><span class="s2">&quot;my_robot_bringup&quot;</span><span class="p">),</span>
            <span class="s2">&quot;config&quot;</span><span class="p">,</span>
            <span class="s2">&quot;controller_configuration.yaml&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="n">rviz_config_file</span> <span class="o">=</span> <span class="n">PathJoinSubstitution</span><span class="p">(</span>
        <span class="p">[</span><span class="n">FindPackageShare</span><span class="p">(</span><span class="s2">&quot;ros2_robot_sca&quot;</span><span class="p">),</span> <span class="s2">&quot;rrbot/rviz&quot;</span><span class="p">,</span> <span class="s2">&quot;rrbot.rviz&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">node_robot_state_publisher</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="s2">&quot;robot_state_publisher&quot;</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="s2">&quot;robot_state_publisher&quot;</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="s2">&quot;screen&quot;</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="n">robot_description</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">joint_state_broadcaster_spawner</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="s2">&quot;controller_manager&quot;</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="s2">&quot;spawner&quot;</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;joint_state_broadcaster&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">robot_controller_spawner</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="s2">&quot;controller_manager&quot;</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="s2">&quot;spawner&quot;</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;forward_position_controller&quot;</span><span class="p">,</span> <span class="s2">&quot;--param-file&quot;</span><span class="p">,</span> <span class="n">robot_controllers</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">gazebo</span><span class="p">,</span>
        <span class="n">node_robot_state_publisher</span><span class="p">,</span>
        <span class="n">gz_spawn_entity</span><span class="p">,</span>
        <span class="n">joint_state_broadcaster_spawner</span><span class="p">,</span>
        <span class="n">robot_controller_spawner</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">LaunchDescription</span><span class="p">(</span><span class="n">declared_arguments</span> <span class="o">+</span> <span class="n">nodes</span><span class="p">)</span>
</code></pre></div></p>
<p>A continuación, se describirá el fichero launch por partes:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">launch</span><span class="w"> </span><span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch.actions</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclareLaunchArgument</span><span class="p">,</span> <span class="n">IncludeLaunchDescription</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch.conditions</span><span class="w"> </span><span class="kn">import</span> <span class="n">IfCondition</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch.launch_description_sources</span><span class="w"> </span><span class="kn">import</span> <span class="n">PythonLaunchDescriptionSource</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch.substitutions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Command</span><span class="p">,</span> <span class="n">FindExecutable</span><span class="p">,</span> <span class="n">PathJoinSubstitution</span><span class="p">,</span> <span class="n">LaunchConfiguration</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch_ros.actions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch_ros.substitutions</span><span class="w"> </span><span class="kn">import</span> <span class="n">FindPackageShare</span>
</code></pre></div>
<p>Agregar estas declaraciones de importación nos permitirá utilizar las funciones definidas dentro de estos módulos.
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_launch_description</span><span class="p">():</span>
</code></pre></div>
Aquí definimos una función que retornará un objeto LaunchDescription.
<div class="highlight"><pre><span></span><code><span class="n">gz_spawn_entity</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="s2">&quot;ros_gz_sim&quot;</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="s2">&quot;create&quot;</span><span class="p">,</span>
    <span class="n">output</span><span class="o">=</span><span class="s2">&quot;screen&quot;</span><span class="p">,</span>
    <span class="n">arguments</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;-topic&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/robot_description&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rrbot_system_position&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-allow_renaming&quot;</span><span class="p">,</span>
        <span class="s2">&quot;true&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>
</code></pre></div>
Este código sirve para generar en Gazebo la versión actualizada del modelo del robot (que incluye los elementos de ros2_control).</p>
<p><div class="highlight"><pre><span></span><code><span class="n">robot_description_content</span> <span class="o">=</span> <span class="n">Command</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">PathJoinSubstitution</span><span class="p">([</span><span class="n">FindExecutable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;xacro&quot;</span><span class="p">)]),</span>
        <span class="s2">&quot; &quot;</span><span class="p">,</span>
        <span class="n">PathJoinSubstitution</span><span class="p">(</span>
            <span class="p">[</span><span class="n">FindPackageShare</span><span class="p">(</span><span class="s2">&quot;ros2_robot_sca&quot;</span><span class="p">),</span> <span class="s2">&quot;urdf&quot;</span><span class="p">,</span> <span class="s2">&quot;rrbot.urdf.xacro&quot;</span><span class="p">]</span>
        <span class="p">),</span>
         <span class="s2">&quot;,</span>
        <span class="s2">&quot;use_gazebo:=true&quot;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">robot_description</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;robot_description&quot;</span><span class="p">:</span> <span class="n">robot_description_content</span><span class="p">}</span>
</code></pre></div>
En ROS2, usamos el módulo xacro de Python con un código como el anterior para analizar archivos xacro directamente en el archivo de lanzamiento. Básicamente, esto carga el modelo del robot definido dentro del archivo xacro y lo almacena en la variable robot_description para su uso posterior.</p>
<p><div class="highlight"><pre><span></span><code><span class="n">node_robot_state_publisher</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="s2">&quot;robot_state_publisher&quot;</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="s2">&quot;robot_state_publisher&quot;</span><span class="p">,</span>
    <span class="n">output</span><span class="o">=</span><span class="s2">&quot;screen&quot;</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="n">robot_description</span><span class="p">],</span>
<span class="p">)</span>
</code></pre></div>
En este código se genera un nodo robot_state_publisher, proporcionando la variable robot_description como parámetro. Este nodo lee el topic /joint_states del joint_state_broadcaster y proporciona una realimentación continua de las ubicaciones de las articulaciones del robot a través de los topics tf y tf_static.
<div class="highlight"><pre><span></span><code><span class="n">joint_state_broadcaster_spawner</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="s2">&quot;controller_manager&quot;</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="s2">&quot;spawner&quot;</span><span class="p">,</span>
    <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;joint_state_broadcaster&quot;</span><span class="p">],</span>
<span class="p">)</span>
</code></pre></div>
Aquí se utiliza un script de Python llamado spawner, que es proporcionado por el paquete controller_manager, para cargar e iniciar el joint_state_broadcaster. </p>
<p>El joint_state_broadcaster publica el estado del robot en los topics "/rrbot_controller/state" y "/joint_states". El estado del robot, descrito por la posición, velocidad y esfuerzo de cada articulación, se transmite como un mensaje "sensor_msgs/JointState" de ROS2, que puede ser leído por cualquier nodo de ROS2.
<div class="highlight"><pre><span></span><code><span class="n">robot_controller_spawner</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="s2">&quot;controller_manager&quot;</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="s2">&quot;spawner&quot;</span><span class="p">,</span>
    <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;forward_position_controller&quot;</span><span class="p">,</span> <span class="s2">&quot;--param-file&quot;</span><span class="p">,</span> <span class="n">robot_controllers</span><span class="p">],</span>
<span class="p">)</span>
</code></pre></div>
Aquí se utiliza el mismo script que antes para cargar e iniciar un forward_position_controller (que se ha definido anteriormente en el fichero controller_configuration.yaml). Con este controlador cargado, se puede enviar comandos de posición a las articulaciones del robot.</p>
<p>A continuación, es necesario asegurarse que ROS reconoce el fichero launch que acabamos de crear. Para ello, abrir el fichero CMakeLists.txt (del paquete my_robot_bringup) y añadir un comando install(DIRECTORY...) al final del fichero:
<div class="highlight"><pre><span></span><code>install(
  DIRECTORY
    launch
    config
  DESTINATION
    share/${PROJECT_NAME}/
)
</code></pre></div>
Esto le indica a colcon build que coloque una copia o un enlace tanto de la carpeta launch como del archivo de configuración YAML en el directorio share. Este directorio es el lugar predeterminado donde ROS2 buscará elementos como archivos de lanzamiento. Asegúrate de guardar todo y ejecuta colcon build:
<div class="highlight"><pre><span></span><code>cd ~/ros2_ws
</code></pre></div></p>
<div class="highlight"><pre><span></span><code>colcon build
</code></pre></div>
<div class="highlight"><pre><span></span><code>source install/setup.bash
</code></pre></div>
<h2 id="probar-el-robot-controlado-por-ros2_control">Probar el robot controlado por ros2_control</h2>
<p>En este apartado se va a comprobar si todo funciona correctamente. Para ello, ejecutar el comando ros2 launch en un terminal:
<div class="highlight"><pre><span></span><code>ros2 launch my_robot_bringup my_robot.launch.py
</code></pre></div>
Se mostrará un mensaje en la consola confirmando que tanto joint_state_broadcaster como forward_position_controller han sido cargados, configurados e iniciados.</p>
<p><img alt="Inicialización y carga de los controladores" src="../images/inic2controladores.png" /></p>
<p>Ahora deberías ver el modelo del robot aparecer en Gazebo:</p>
<p><img alt="Robot con un solo grado de libertad controlado" src="../images/robot1gdlc.png" /></p>
<p>A continuación, se va a comprobar los topics disponibles para enviar comandos. Para ello, abrir un nuevo terminal y ejecutar los siguientes comandos:
<div class="highlight"><pre><span></span><code>cd ~/ros2_ws
source install/setup.bash
ros2 topic list
</code></pre></div>
Entre otros, deberías ver que el siguiente topic está disponible, que lo utilizaremos para enviar comandos al robot:
<div class="highlight"><pre><span></span><code>/forward_position_controllers/commands
</code></pre></div>
<img alt="Lista de topics" src="../images/inicControl.png" /></p>
<p>Podemos usar este comando para publicar datos en el topic (se mueve la primera articulación a la posición 0.79 en radianes):
<div class="highlight"><pre><span></span><code>ros2 topic pub /forward_position_controller/commands std_msgs/msg/Float64MultiArray &quot;data:
- 0.79&quot; -1
</code></pre></div>
Si todo ha ido bien deberías ver lo siguiente:</p>
<p><img alt="Robot con un solo grado de libertad controlado" src="../images/robot1gdlc2.png" /></p>
<p>Con solo unos pocos pasos de configuración y sin necesidad de desarrollo, ahora podemos mover el robot publicando comandos en un topic. Nuestro robot ya puede interactuar con todo el ecosistema de ROS2.</p>
<h2 id="ejercicio">Ejercicio</h2>
<div class="admonition note annotate">
<p class="admonition-title">Ejercicio</p>
<p>Para aplicar lo aprendido, en este ejercicio tendremos que indicarle a ros2_control que también queremos controlar la segunda articulación del robot, la que tiene el nombre joint2. Para eso, se deberán modificar los archivos en los que has trabajado hasta ahora y ampliarlos para agregar la segunda articulación, de modo que al final puedas mover ambas articulaciones en el robot simulado usando ros2_control.</p>
<p>Una vez hecho esto, ejecutar el siguiente comando en una terminal:
<div class="highlight"><pre><span></span><code>ros2 launch my_robot_bringup my_robot.launch.py
</code></pre></div>
En otra terminal ejecutar los siguientes comandos:
<div class="highlight"><pre><span></span><code>ros2 topic pub /forward_position_controller/commands std_msgs/msg/Float64MultiArray &quot;data:
- 1.57
- -1.57&quot; -1
</code></pre></div>
<div class="highlight"><pre><span></span><code>ros2 topic pub /forward_position_controller/commands std_msgs/msg/Float64MultiArray &quot;data:
- -1.57
- 0.79&quot; -1
</code></pre></div>
Los comandos anteriores deberían colocar el robot en las siguientes posiciones:</p>
<p><img alt="Robot con un 2 grados de libertad controlados. Prueba 1" src="../images/pos2con2gdl.png" />
<img alt="Robot con un 2 grados de libertad controlados. Prueba 2" src="../images/pos1con2gdl.png" /></p>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.code.select", "content.code.copy"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>